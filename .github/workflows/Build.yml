name: Build SKY Plugin

on:
  push:
    paths:
      - "src/**/*.js"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed JS files
        id: changed
        run: |
          FILES=$(git diff --name-only HEAD^ HEAD | grep '^src/.*\.js$' || true)
          echo "FILES=$FILES" >> $GITHUB_ENV

      - name: Build .sky files
        if: env.FILES != ''
        run: |
          mkdir -p build

          for file in $FILES; do
            NAME=$(basename "$file" .js)

            rm -rf tmp
            mkdir tmp

            # plugin.js oluştur
            touch tmp/plugin.js

            # libs varsa en başa ekle
            if [ -d "libs" ]; then
              for lib in libs/*.js; do
                [ -f "$lib" ] && cat "$lib" >> tmp/plugin.js
              done
            fi

            # asıl dosyayı alta ekle
            cat "$file" >> tmp/plugin.js

            # sky oluştur
            (cd tmp && zip -q "../build/${NAME}.sky" plugin.js)

            rm -rf tmp
          done

      - name: Commit build output
        if: env.FILES != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add build/*.sky || true
          git commit -m "build: update .sky plugin(s)" || echo "Nothing to commit"
          git push
